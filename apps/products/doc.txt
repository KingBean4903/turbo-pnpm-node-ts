FROM node:22-alpine AS base

RUN apk update

WORKDIR /app

# --
FROM base AS prepare

RUN pnpm add turbo --global

COPY . .

RUN turbo prune products --docker

# ---
FROM base AS builder

COPY --from=prepare /app/out/json/ .

RUN pnpm install

COPY --from=prepare /app/out/full/ .

RUN pnpm install

RUN node turbo build

# --- 
FROM base AS runner

COPY --from=builder /app/apps/products/dist ./apps/products/dist

EXPOSE 4500

CMD ["node", "apps/products/dist/main.js"]
