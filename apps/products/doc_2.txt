
# FROM node:22-slim AS base
FROM node:22-alpine AS base

# RUN corepack enable
# ENV PNPM_HOME="/pnpm"
# ENV PATH="$PNPM_HOME:$PATH"
# RUN apk update
RUN apk add --no-cache libc6-compat

WORKDIR /app

# FROM node:22-slim AS prepare
RUN corepack enable
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
WORKDIR /app

FROM base AS prepare
# RUN touch pnpm-workspace.yaml

RUN pnpm add turbo --global

COPY . .

RUN turbo prune products --docker

# ---
# FROM node:22-slim AS builder
# RUN corepack enable
# ENV PNPM_HOME="/pnpm"
# ENV PATH="$PNPM_HOME:$PATH"
# WORKDIR /app

FROM base AS builder

RUN pnpm add turbo --global

COPY --from=prepare /app/out/json/ .

RUN pnpm -r update

RUN pnpm install

COPY --from=prepare /app/out/full/ .

RUN pnpm turbo build

# --- 
FROM base AS runner
# FROM node:22-slim AS runner
# RUN corepack enable
# ENV PNPM_HOME="/pnpm"
# ENV PATH="$PNPM_HOME:$PATH"
# WORKDIR /app

# COPY --from=builder /app/apps/products/dist ./apps/products/dist
# COPY --from=builder /app/apps/products/package.json ./apps/products/

# COPY --from=builder /app/apps/products/pnpm-lock.yaml ./apps/products
# COPY --from=builder /app/apps/products/ ./apps/products/
# COPY --from=builder /app/apps/products/package.json .
# COPY --from=builder /app/apps/products/node_modules ./node_modules

COPY --from=builder /app/apps/products/dist ./apps/products/dist
COPY --from=builder /app/apps/products/package.json ./apps/products/
COPY --from=builder /app/apps/products/node_modules ./apps/products/node_modules


CMD ["node", "apps/products/dist/main.js"]
